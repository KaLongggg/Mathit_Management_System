<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>MathitHK Management</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<!-- Inter font for nicer typography -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

<!-- Tailwind config BEFORE CDN (Play CDN style) -->
<script>
  window.tailwind = {
    config: {
      darkMode: 'media',
      theme: {
        extend: {
          fontFamily: { sans: ['Inter', 'ui-sans-serif', 'system-ui'] },
          colors: { brand: { teal: '#37889b', red: '#ff5c5c', paper: '#f5f9ff' } },
          boxShadow: { soft: '0 10px 30px rgba(0,0,0,.08)' }
        }
      }
    }
  }
</script>
<script src="https://cdn.tailwindcss.com"></script>

<!-- Component layer -->
<script type="text/tailwindcss">
@layer components {
  .wrap { @apply max-w-7xl mx-auto px-4 sm:px-6 lg:px-8; }

  .card {
    @apply bg-white dark:bg-zinc-900 rounded-2xl shadow-soft border border-zinc-200/60 dark:border-zinc-800;
  }

  .btn {
    @apply inline-flex items-center justify-center rounded-xl px-4 py-2 font-medium transition
           focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-brand-teal;
  }
  .btn:disabled { @apply opacity-60 cursor-not-allowed; }
  .btn-primary { @apply bg-brand-teal text-white hover:opacity-90; }
  .btn-ghost   { @apply bg-zinc-100 dark:bg-zinc-800 hover:bg-zinc-200 dark:hover:bg-zinc-700; }
  .btn-danger  { @apply bg-red-600 text-white hover:bg-red-500; }

  .navlink { @apply btn btn-ghost text-sm sm:text-base; }
  .navlink[data-active="true"] { @apply bg-brand-teal/10 text-brand-teal; }

  .input {
    @apply w-full rounded-xl border border-zinc-300 dark:border-zinc-700
           bg-white dark:bg-zinc-900 px-3 py-2
           text-zinc-900 dark:text-zinc-100
           placeholder:text-zinc-500 dark:placeholder:text-zinc-400
           focus:outline-none focus:ring-2 focus:ring-brand-teal;
  }

  .pill{ @apply inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-medium; }
  .pill-green{ @apply bg-green-100 text-green-700 dark:bg-green-900/40 dark:text-green-300; }
  .pill-red{ @apply bg-red-100 text-red-700 dark:bg-red-900/40 dark:text-red-300; }
  .skeleton{ @apply animate-pulse bg-zinc-200 dark:bg-zinc-800 rounded-lg h-[14px]; }

  .spinner { @apply inline-block h-4 w-4 animate-spin rounded-full border-2 border-current border-t-transparent; }
}
</script>

<style>
  /* Hard fallback to ensure readable text if Tailwind fails */
  body, input, textarea { color:#111 !important; }
</style>
</head>

<body class="bg-gradient-to-b from-brand-paper to-white dark:from-zinc-950 dark:to-zinc-950 text-zinc-900 dark:text-zinc-50">
<div class="min-h-screen flex flex-col">
  <!-- Topbar -->
  <header class="sticky top-0 z-40 border-b border-zinc-200/70 dark:border-zinc-800 bg-white/80 dark:bg-zinc-950/70 backdrop-blur">
    <div class="wrap py-3 flex items-center gap-3">
      <a href="#/dashboard" class="flex items-center gap-2">
        <div class="w-9 h-9 rounded-xl bg-brand-teal"></div>
        <span class="text-base sm:text-lg font-semibold">MathitHK Management</span>
      </a>

      <!-- Desktop nav -->
      <nav class="ml-auto hidden md:flex gap-2" id="navLinks" hidden>
        <a href="#/dashboard" class="navlink" data-nav>Dashboard</a>
        <a href="#/courses"   class="navlink" data-nav>Courses</a>
        <a href="#/students"  class="navlink" data-nav>Students</a>
        <button id="btnSignOut" class="navlink" type="button">Sign out</button>
      </nav>

      <!-- Mobile menu button -->
      <button id="btnMenu" class="ml-auto md:hidden btn btn-ghost" aria-controls="mobileNav" aria-expanded="false" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 6h16M4 12h16M4 18h16"/>
        </svg>
        <span class="sr-only">Toggle menu</span>
      </button>
    </div>

    <!-- Mobile nav panel -->
    <div id="mobileNav" class="wrap md:hidden hidden pb-3" aria-label="Mobile">
      <div class="grid gap-2">
        <a href="#/dashboard" class="navlink" data-nav>Dashboard</a>
        <a href="#/courses"   class="navlink" data-nav>Courses</a>
        <a href="#/students"  class="navlink" data-nav>Students</a>
        <button id="btnSignOutMobile" class="navlink" type="button">Sign out</button>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main class="flex-1">
    <div class="wrap py-8">
      <!-- Auth view -->
      <section id="authView" class="max-w-6xl mx-auto" hidden>
        <div class="grid md:grid-cols-2 gap-8 items-stretch">
          <!-- Brand panel -->
          <div class="hidden md:flex card p-8 bg-gradient-to-br from-brand-teal/10 to-emerald-200/20 dark:from-zinc-900 dark:to-zinc-900">
            <div class="m-auto max-w-sm">
              <div class="w-12 h-12 rounded-2xl bg-brand-teal mb-4"></div>
              <h2 class="text-2xl font-semibold mb-2">Welcome to MathitHK</h2>
              <p class="text-sm text-zinc-600 dark:text-zinc-400">
                Sign in to access your management dashboard. Only pre-created accounts can log in.
              </p>
              <ul class="mt-6 space-y-2 text-sm text-zinc-700 dark:text-zinc-300">
                <li>• View courses and enrolments</li>
                <li>• Search student records</li>
                <li>• Manage operations securely</li>
              </ul>
            </div>
          </div>

          <!-- Sign-in card -->
          <div class="card p-6 sm:p-8">
            <div class="mb-6">
              <h1 class="text-2xl font-semibold">Sign in</h1>
              <p class="text-sm text-zinc-600 dark:text-zinc-400">Use your work email and password.</p>
            </div>

            <div class="space-y-4">
              <label class="block">
                <span class="block text-sm font-medium mb-1">Email</span>
                <input id="email" type="email" class="input h-11" placeholder="you@company.com" autocomplete="username" />
              </label>

              <label class="block">
                <span class="block text-sm font-medium mb-1">Password</span>
                <div class="relative">
                  <input id="password" type="password" class="input h-11 pr-12" placeholder="••••••••" autocomplete="current-password" />
                  <button type="button" id="togglePwd" class="absolute inset-y-0 right-2 my-auto text-sm text-zinc-500 hover:text-zinc-700 dark:hover:text-zinc-200 px-2">
                    Show
                  </button>
                </div>
              </label>

              <button id="btnSignIn" class="btn btn-primary w-full h-11">Sign in</button>

              <div id="authError" class="hidden p-3 rounded-lg bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-200 text-sm"></div>

              <div class="flex items-center gap-2 text-xs text-zinc-500">
                <div class="h-px flex-1 bg-zinc-200 dark:bg-zinc-800"></div>
                <span>Secure Access</span>
                <div class="h-px flex-1 bg-zinc-200 dark:bg-zinc-800"></div>
              </div>

              <p class="text-xs text-zinc-500">
                Having trouble? Contact an administrator to reset your access.
              </p>
            </div>
          </div>
        </div>
      </section>

      <!-- App view -->
      <div id="appView" hidden>
        <div id="view"></div>
      </div>
    </div>
  </main>

  <footer class="border-t border-zinc-200/70 dark:border-zinc-800 text-xs text-zinc-500">
    <div class="wrap py-4 flex flex-col sm:flex-row gap-2 sm:items-center justify-between">
      <div>© Mathit Limited</div>
      <div>Built with Supabase · Tailwind</div>
    </div>
  </footer>
</div>

<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

// --- Supabase ---
const SUPABASE_URL = "https://pezkjbjtvcapsubwlwgt.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBlemtqYmp0dmNhcHN1Yndsd2d0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY2OTMyNTgsImV4cCI6MjA3MjI2OTI1OH0.spORN3rr34Io-SAdPLGyRzbNgBy2Vdw4UR0o0JrmcG8";
const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// --- Elements ---
const authView  = document.getElementById('authView');
const appView   = document.getElementById('appView');
const navLinks  = document.getElementById('navLinks');
const view      = document.getElementById('view');
const btnMenu   = document.getElementById('btnMenu');
const mobileNav = document.getElementById('mobileNav');

// --- Auth/UI wiring ---
async function refreshUI() {
  const { data: { session } } = await supabase.auth.getSession();
  const authed = !!session;

  authView.hidden  = authed;
  appView.hidden   = !authed;
  navLinks.hidden  = !authed;

  // Show/hide mobile trigger and panel
  btnMenu.hidden   = !authed;
  if (!authed) mobileNav.classList.add('hidden');

  if (authed) navigate(); else location.hash = '#/login';
}

supabase.auth.onAuthStateChange((event, session) => {
  console.log('[auth] onAuthStateChange:', event, !!session);
  refreshUI();
});

// Sign in (with spinner)
const signInBtn = document.getElementById('btnSignIn');
if (signInBtn) {
  signInBtn.addEventListener('click', async (e) => {
    e.preventDefault();
    const email = (document.getElementById('email')?.value || '').trim();
    const password = document.getElementById('password')?.value || '';
    const errEl = document.getElementById('authError');

    errEl.classList.add('hidden'); errEl.textContent = '';
    const prevHTML = signInBtn.innerHTML;
    signInBtn.disabled = true;
    signInBtn.innerHTML = '<span class="spinner mr-2"></span>Signing in…';

    try {
      const { data, error } = await supabase.auth.signInWithPassword({ email, password });
      console.log('[auth] signIn result:', { data, error });
      if (error) {
        errEl.textContent = error.message || 'Sign in failed';
        errEl.classList.remove('hidden');
      } else if (!data?.session) {
        errEl.textContent = 'Signed in but no session. Check email confirmation or Auth settings.';
        errEl.classList.remove('hidden');
      }
    } catch (ex) {
      errEl.textContent = 'Unexpected error: ' + (ex?.message || ex);
      errEl.classList.remove('hidden');
    } finally {
      signInBtn.disabled = false;
      signInBtn.innerHTML = prevHTML;
    }
  });
}

// Sign out (both navs)
document.getElementById('btnSignOut')?.addEventListener('click', async () => {
  await supabase.auth.signOut();
  location.hash = '#/login';
});
document.getElementById('btnSignOutMobile')?.addEventListener('click', async () => {
  await supabase.auth.signOut();
  location.hash = '#/login';
  mobileNav.classList.add('hidden');
  btnMenu.setAttribute('aria-expanded', 'false');
});

// Mobile menu toggle
btnMenu?.addEventListener('click', () => {
  const isHidden = mobileNav.classList.toggle('hidden');
  btnMenu.setAttribute('aria-expanded', (!isHidden).toString());
});

// Active nav highlight
function setActiveNav() {
  const path = (location.hash || '#/dashboard').replace(/^#/, '');
  const current = `#${path}`;
  document.querySelectorAll('[data-nav]').forEach(a => {
    a.dataset.active = (a.getAttribute('href') === current);
  });
  // close mobile panel after navigation tap
  if (!mobileNav.classList.contains('hidden')) {
    mobileNav.classList.add('hidden');
    btnMenu.setAttribute('aria-expanded', 'false');
  }
}

// --- Router with guard ---
const routes = {
  "/dashboard": renderDashboard,
  "/courses": renderCourses,
  "/students": renderStudents,
  "/login": renderLogin
};

async function navigate(){
  const path = (location.hash || '#/dashboard').replace(/^#/, '');
  const { data:{ session } } = await supabase.auth.getSession();

  if (!session) {
    if (path !== '/login') location.hash = '#/login';
    renderLogin();
    setActiveNav();
    return;
  }

  if (path === '/login' || path === '') {
    location.hash = '#/dashboard';
    renderDashboard();
    setActiveNav();
    return;
  }

  (routes[path] || renderDashboard)();
  setActiveNav();
}

window.addEventListener('hashchange', navigate);
window.addEventListener('load', navigate);

// --- Views ---
function renderLogin(){ authView.hidden = false; appView.hidden = true; navLinks.hidden = true; }

function renderDashboard(){
  appView.hidden = false; authView.hidden = true;
  view.innerHTML = `
    <section class="grid gap-6 md:grid-cols-3">
      <div class="card p-6">
        <h2 class="font-semibold mb-2">New Enrolments (This Week)</h2>
        <div class="skeleton w-1/2 mb-2"></div>
        <p class="text-sm text-zinc-500">Chart placeholder</p>
      </div>
      <div class="card p-6">
        <h2 class="font-semibold mb-2">New Students</h2>
        <div class="skeleton w-2/3 mb-2"></div>
        <p class="text-sm text-zinc-500">Chart placeholder</p>
      </div>
      <div class="card p-6">
        <h2 class="font-semibold mb-2">Revenue (MTD)</h2>
        <div class="skeleton w-1/3 mb-2"></div>
        <p class="text-sm text-zinc-500">Chart placeholder</p>
      </div>
    </section>`;
}

const fmtMoney = (n)=> n==null?'-':new Intl.NumberFormat('en-AU',{style:'currency',currency:'AUD'}).format(n);
const fmtDate = (s)=> s? new Date(s).toLocaleString() : '-';
function escapeHtml(s){ if(s==null) return ''; return String(s).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
function escapeOr(s){ return String(s).replace(/[,()]/g,"\\$&"); }

async function renderCourses(){
  appView.hidden = false; authView.hidden = true;
  view.innerHTML = `
  <section class="card p-6">
    <div class="flex flex-col sm:flex-row sm:items-center gap-3 mb-4">
      <h2 class="text-xl font-semibold">Courses</h2>
      <div class="sm:ml-auto flex gap-2 w-full sm:w-auto">
        <input id="qCourse" class="input h-11 flex-1" placeholder="Search by name or ID...">
        <button id="btnCourseSearch" class="btn btn-primary h-11">Search</button>
      </div>
    </div>
    <div class="overflow-x-auto">
      <table class="min-w-full text-sm">
        <thead>
          <tr class="text-left text-zinc-600 dark:text-zinc-400">
            <th class="py-2">ID</th><th class="py-2">Name</th><th class="py-2">Year</th>
            <th class="py-2">Duration</th><th class="py-2">Price</th><th class="py-2">Free</th><th class="py-2">Created</th>
          </tr>
        </thead>
        <tbody id="courseRows"></tbody>
      </table>
    </div>
  </section>`;
  const rowsEl = document.getElementById('courseRows');
  const load = async (term='')=>{
    rowsEl.innerHTML = '';
    let q = supabase.from('course').select('course_id,course_name,year,duration,price,free_course,create_date')
      .order('create_date',{ascending:false}).limit(200);
    if(term) q = q.or(`course_name.ilike.%${term}%,course_id.ilike.%${term}%`);
    const { data, error } = await q;
    if(error){ rowsEl.innerHTML = `<tr><td colspan="7" class="py-6 text-center text-red-600">${escapeHtml(error.message)}</td></tr>`; return; }
    if(!data?.length){ rowsEl.innerHTML = `<tr><td colspan="7" class="py-6 text-center text-zinc-500">No courses found.</td></tr>`; return; }
    rowsEl.innerHTML = data.map(c=>`
      <tr class="border-t border-zinc-200/70 dark:border-zinc-800">
        <td class="py-2 font-medium">${c.course_id}</td>
        <td class="py-2">${escapeHtml(c.course_name)}</td>
        <td class="py-2">${c.year ?? '-'}</td>
        <td class="py-2">${c.duration ?? '-'}</td>
        <td class="py-2">${fmtMoney(Number(c.price))}</td>
        <td class="py-2">${c.free_course?'<span class="pill pill-green">Free</span>':'<span class="pill pill-red">Paid</span>'}</td>
        <td class="py-2">${c.create_date ?? '-'}</td>
      </tr>`).join('');
  };
  document.getElementById('btnCourseSearch').onclick = ()=> load(document.getElementById('qCourse').value.trim());
  document.getElementById('qCourse').addEventListener('keydown', e=>{ if(e.key==='Enter') document.getElementById('btnCourseSearch').click(); });
  load();
}

async function renderStudents(){
  appView.hidden=false; authView.hidden=true;
  view.innerHTML = `
  <section class="card p-6">
    <h2 class="text-xl font-semibold mb-4">Find Student</h2>
    <div class="grid sm:grid-cols-2 lg:grid-cols-4 gap-3 mb-4">
      <input id="qFirst" class="input h-11" placeholder="First name">
      <input id="qLast"  class="input h-11" placeholder="Last name">
      <input id="qEmail" class="input h-11" placeholder="Email">
      <input id="qPhone" class="input h-11" placeholder="WhatsApp / Phone">
    </div>
    <div class="flex flex-col sm:flex-row gap-2 mb-4">
      <button id="btnStudentSearch" class="btn btn-primary h-11">Search</button>
      <button id="btnStudentClear" class="btn btn-ghost h-11">Clear</button>
    </div>
    <div id="studentResult" class="grid md:grid-cols-2 gap-4"></div>
  </section>`;
  const resEl = document.getElementById('studentResult');

  const search = async ()=>{
    const first = document.getElementById('qFirst').value.trim();
    const last  = document.getElementById('qLast').value.trim();
    const email = document.getElementById('qEmail').value.trim();
    const phone = document.getElementById('qPhone').value.trim();
    resEl.innerHTML = '';

    if(!first && !last && !email && !phone){
      resEl.innerHTML = `<div class="text-zinc-500">Enter at least one field to search.</div>`;
      return;
    }

    let q = supabase.from('student').select('*').limit(50);
    const ors = [];
    if (first) ors.push(`first_name.ilike.%${escapeOr(first)}%`);
    if (last)  ors.push(`last_name.ilike.%${escapeOr(last)}%`);
    if (email) ors.push(`email.ilike.%${escapeOr(email)}%`);
    if (phone) ors.push(`phone_number.ilike.%${escapeOr(phone)}%`);
    q = q.or(ors.join(',')).order('last_sign_in', { ascending:false });

    const { data, error } = await q;
    if (error) { resEl.innerHTML = `<div class="text-red-600">${escapeHtml(error.message)}</div>`; return; }
    if (!data?.length) { resEl.innerHTML = `<div class="text-zinc-500">No matching students.</div>`; return; }

    resEl.innerHTML = data.map(s=> studentCard(s)).join('');
    data.forEach(s=>{
      const el = document.getElementById(`stu-${cssId(s.student_id)}`);
      if(el) el.onclick = ()=> { location.hash = `#/student/${encodeURIComponent(s.student_id)}`; };
    });
  };

  document.getElementById('btnStudentSearch').onclick = search;
  document.getElementById('btnStudentClear').onclick = ()=>{
    ['qFirst','qLast','qEmail','qPhone'].forEach(id=>document.getElementById(id).value='');
    resEl.innerHTML = '';
  };
}

function cssId(s){ return String(s).replace(/[^a-zA-Z0-9_-]/g, '_'); }
function studentCard(s){
  return `
  <div id="stu-${cssId(s.student_id)}" class="card p-5 hover:ring-2 hover:ring-brand-teal/60 transition cursor-pointer">
    <div class="flex items-start justify-between gap-4">
      <div>
        <div class="text-lg font-semibold">${escapeHtml(s.first_name)} ${escapeHtml(s.last_name)}</div>
        <div class="text-sm text-zinc-600 dark:text-zinc-400">${escapeHtml(s.email ?? '')}</div>
      </div>
      <div>${s.is_active?'<span class="pill pill-green">Active</span>':'<span class="pill pill-red">Inactive</span>'}</div>
    </div>
    <div class="mt-2 text-sm text-zinc-600 dark:text-zinc-400">
      <span class="mr-4">ID: ${escapeHtml(s.student_id)}</span>
      <span>WhatsApp: ${escapeHtml(s.phone_number ?? '-')}</span>
    </div>
  </div>`;
}

// Show login immediately, then reconcile
renderLogin();
refreshUI();
</script>
</body>
</html>
